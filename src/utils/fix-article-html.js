#!/usr/bin/env node
/**
 * Batch-fix all artigo HTML files:
 * 1. Add onerror handler to article images (broken Unsplash URLs)
 * 2. Replace invalid photo IDs with verified working ones
 * 3. Fix <header> nav structure in files generated by create-regionais-articles.js
 */
const fs = require('fs').promises;
const path = require('path');

const ARTIGO_DIR = path.join(__dirname, '../../public/artigo');

// Verified working Unsplash photo IDs (football themed)
const RELIABLE_IMAGES = [
    'https://images.unsplash.com/photo-1431324155629-1a6deb1dec8d?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1546519638-68e109498ffc?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1517466787929-bc90951d0974?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1508098682722-e99c43a406b2?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1560272564-c83b66b1ad12?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1521537634581-0dced2fee2ef?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1576206483374-5afe7a616717?w=800&h=450&fit=crop&q=80',
    'https://images.unsplash.com/photo-1518604964608-d2e32de0920f?w=800&h=450&fit=crop&q=80',
];

// Map of article ID keywords â†’ specific verified image
const KEYWORD_IMAGES = {
    'neymar':        RELIABLE_IMAGES[8],
    'santos':        RELIABLE_IMAGES[8],
    'paulistao':     RELIABLE_IMAGES[0],
    'corinthians':   RELIABLE_IMAGES[1],
    'carioca':       RELIABLE_IMAGES[2],
    'flamengo':      RELIABLE_IMAGES[2],
    'mineiro':       RELIABLE_IMAGES[6],
    'atletico':      RELIABLE_IMAGES[6],
    'gaucho':        RELIABLE_IMAGES[7],
    'grenal':        RELIABLE_IMAGES[7],
    'nordestao':     RELIABLE_IMAGES[3],
    'fortaleza':     RELIABLE_IMAGES[3],
    'paranaense':    RELIABLE_IMAGES[4],
    'athletico':     RELIABLE_IMAGES[4],
    'pernambucano':  RELIABLE_IMAGES[5],
    'sport':         RELIABLE_IMAGES[5],
    'palmeiras':     RELIABLE_IMAGES[0],
    'brasileirao':   RELIABLE_IMAGES[1],
    'var':           RELIABLE_IMAGES[1],
    'copa':          RELIABLE_IMAGES[2],
    'tatica':        RELIABLE_IMAGES[7],
};

function getImageForFile(filename) {
    const id = filename.toLowerCase().replace('.html', '');
    for (const [kw, url] of Object.entries(KEYWORD_IMAGES)) {
        if (id.includes(kw)) return url;
    }
    // hash-based fallback for consistent assignment
    const idx = id.charCodeAt(0) % RELIABLE_IMAGES.length;
    return RELIABLE_IMAGES[idx];
}

const FALLBACK_IMG = RELIABLE_IMAGES[0];

// Header template for regional articles (clean, works with article.css)
function buildCleanHeader(logoHref, navLinks) {
    return `    <header style="background:linear-gradient(135deg,#009739 0%,#007d2f 100%);padding:14px 0;box-shadow:0 2px 8px rgba(0,0,0,.15);">
        <div class="container" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
            <a href="${logoHref}" style="color:white;text-decoration:none;font-size:18px;font-weight:900;letter-spacing:.5px;">BOLA NA REDE <span style="font-size:12px;font-weight:400;opacity:.7;display:block;">O futebol sem filtro</span></a>
            <nav style="display:flex;gap:4px;flex-wrap:wrap;">
                ${navLinks.map(([href, label]) => `<a href="${href}" style="color:rgba(255,255,255,.85);text-decoration:none;font-size:13px;font-weight:600;padding:6px 12px;border-radius:6px;transition:background .2s;" onmouseover="this.style.background='rgba(255,255,255,.15)'" onmouseout="this.style.background=''">${label}</a>`).join('')}
            </nav>
        </div>
    </header>`;
}

const NAV_LINKS = [['/', 'InÃ­cio'], ['/#brasileirao', 'SÃ©rie A'], ['/regionais.html', 'Regionais'], ['/#copa', 'Copa 2026'], ['/#mercado', 'Mercado']];

async function fixFile(filename) {
    const filepath = path.join(ARTIGO_DIR, filename);
    let html = await fs.readFile(filepath, 'utf8');
    let changed = false;

    const targetImg = getImageForFile(filename);

    // 1. Fix <figure class="article-image"> img src + add onerror
    html = html.replace(
        /(<figure[^>]*class="article-image"[^>]*>\s*<img\s)([^>]*)(>)/gi,
        (match, before, attrs, end) => {
            // Update src to reliable URL
            let newAttrs = attrs
                .replace(/src="[^"]*"/, `src="${targetImg}"`)
                .replace(/\s*onerror="[^"]*"/, ''); // remove old onerror
            // Add onerror
            newAttrs += ` onerror="this.src='${FALLBACK_IMG}';this.onerror=null;" loading="eager" style="width:100%;height:auto;min-height:220px;object-fit:cover;display:block;"`;
            changed = true;
            return `${before}${newAttrs}${end}`;
        }
    );

    // 2. Fix og:image meta tag
    html = html.replace(
        /(<meta\s+property="og:image"\s+content=")[^"]*(")/,
        `$1${targetImg}$2`
    );

    // 3. Fix <header> â€” replace broken header structure with clean inline-styled one
    // Only for regional articles (our generated ones) that have a bare <header>
    if (html.includes('<header>') && html.includes('class="container"') && !html.includes('class="site-header"')) {
        const cleanHeader = buildCleanHeader('/', NAV_LINKS);
        html = html.replace(/<header>[\s\S]*?<\/header>/, cleanHeader);
        changed = true;
    }

    // 4. Fix LD+JSON datePublished to match article
    if (html.includes('"datePublished"')) {
        // Keep as is â€” dates are fine
    }

    if (changed) {
        await fs.writeFile(filepath, html, 'utf8');
        return true;
    }
    return false;
}

async function run() {
    const files = (await fs.readdir(ARTIGO_DIR)).filter(f => f.endsWith('.html'));
    let fixed = 0;

    for (const file of files) {
        try {
            const wasFixed = await fixFile(file);
            if (wasFixed) {
                fixed++;
                console.log(`âœ… ${file}`);
            }
        } catch (e) {
            console.error(`âŒ ${file}: ${e.message}`);
        }
    }

    console.log(`\nðŸ”§ Corrigidos: ${fixed}/${files.length} arquivos`);
}

run().catch(e => { console.error(e); process.exit(1); });
