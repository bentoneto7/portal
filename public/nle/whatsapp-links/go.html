<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redirecionando...</title>
<style>
body{font-family:-apple-system,sans-serif;background:#0a0f1c;color:#e8ecf1;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;text-align:center}
.msg{padding:40px;max-width:400px}
.msg h2{margin-bottom:12px;color:#3b82f6}
.msg p{color:#8899aa;font-size:.9rem;line-height:1.5}
.spinner{width:40px;height:40px;border:4px solid #2a3a4e;border-top:4px solid #3b82f6;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="msg" id="msg">
<div class="spinner"></div>
<h2>Redirecionando para o WhatsApp...</h2>
<p>Voce sera redirecionado em instantes.</p>
</div>
<script>
(function(){
  var params = new URLSearchParams(window.location.search);
  var linkId = params.get('id');

  if (!linkId) {
    document.getElementById('msg').innerHTML = '<h2 style="color:#ef4444">Link invalido</h2><p>Este link nao existe ou foi removido.</p>';
    return;
  }

  // Buscar definicao do link
  var links = [];
  try { links = JSON.parse(localStorage.getItem('nle_wpp_links') || '[]'); } catch(e) {}

  var link = links.find(function(l) { return String(l.id) === String(linkId); });

  if (!link) {
    document.getElementById('msg').innerHTML = '<h2 style="color:#ef4444">Link invalido</h2><p>Este link nao existe ou foi removido.</p>';
    return;
  }

  // Registrar clique
  var clicks = [];
  try { clicks = JSON.parse(localStorage.getItem('nle_wpp_clicks') || '[]'); } catch(e) {}

  clicks.push({
    linkId: link.id,
    ts: Date.now(),
    referrer: document.referrer || '',
    userAgent: navigator.userAgent || ''
  });

  try { localStorage.setItem('nle_wpp_clicks', JSON.stringify(clicks)); } catch(e) {}

  // Construir URL do WhatsApp e redirecionar
  var numero = (link.numero || '').replace(/\D/g, '');
  var mensagem = encodeURIComponent(link.mensagem || '');
  var waUrl = 'https://wa.me/' + numero;
  if (mensagem) waUrl += '?text=' + mensagem;

  window.location.href = waUrl;
})();
</script>
</body>
</html>
