name: "âš½ Bola na Rede - EdiÃ§Ã£o DiÃ¡ria"

on:
  # Executa todo dia Ã s 07:00 (horÃ¡rio de BrasÃ­lia = 10:00 UTC)
  schedule:
    - cron: '0 10 * * *'

  # Permite execuÃ§Ã£o manual pelo GitHub
  workflow_dispatch:
    inputs:
      max_artigos:
        description: 'NÃºmero mÃ¡ximo de artigos'
        required: false
        default: '8'
        type: string

permissions:
  contents: write

jobs:
  gerar-edicao:
    name: "ðŸ“° Gerar EdiÃ§Ã£o DiÃ¡ria"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "ðŸ“¥ Checkout do repositÃ³rio"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: "ðŸŸ¢ Setup Node.js 18"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: "ðŸ“¦ Instalar dependÃªncias"
        run: npm ci

      - name: "âš½ Executar Agente Jornalista"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          NEWSDATA_API_KEY: ${{ secrets.NEWSDATA_API_KEY }}
          CURRENTS_API_KEY: ${{ secrets.CURRENTS_API_KEY }}
          MAX_ARTIGOS: ${{ github.event.inputs.max_artigos || '8' }}
          MIN_SOURCES: '1'
          AI_MODEL: 'claude-sonnet-4-5-20250514'
          CI: 'true'
        run: node scripts/run-daily.js

      - name: "ðŸ”§ Configurar Git"
        run: |
          git config user.name "Bola na Rede Bot"
          git config user.email "bot@bolanare.de"

      - name: "ðŸ“¤ Commit e Push"
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "â„¹ï¸ Sem alteraÃ§Ãµes para commit"
          else
            DATA=$(TZ=America/Sao_Paulo date '+%d/%m/%Y %H:%M')
            git commit -m "ðŸ“° EdiÃ§Ã£o diÃ¡ria - $DATA

          Artigos gerados automaticamente pelo agente jornalista AI.
          Fontes: RSS feeds, NewsAPI, Currents API
          Processamento: Claude AI (Anthropic)"
            git push origin main
            echo "âœ… Push realizado com sucesso!"
          fi

      - name: "ðŸ“Š Resumo da execuÃ§Ã£o"
        if: always()
        run: |
          echo "## âš½ Bola na Rede - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Data:** $(TZ=America/Sao_Paulo date '+%d/%m/%Y %H:%M BRT')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f data/articles-index.json ]; then
            TOTAL=$(cat data/articles-index.json | python3 -c "import sys,json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "?")
            echo "**Total de artigos no Ã­ndice:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ãšltimos artigos publicados:**" >> $GITHUB_STEP_SUMMARY
          git log --oneline -5 >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
